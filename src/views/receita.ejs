<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title><%= recipe.title %> | Receita Tech</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/receita.css" />
  </head>
  <body>
    <%- include('partials/_navbar') %>

    <main class="container-receita" style="position:relative;">

      <%
        const avatarUrl = recipe.author_avatar || '/assets/icon-perfil.svg';
        const tempoFormatado = formatTempo
          ? formatTempo(recipe.prep_time_min)
          : (recipe.prep_time_min || '—');

        // ------- NORMALIZA INGREDIENTES -------
        let ingredientes = [];
        if (Array.isArray(recipe.ingredients)) {
          ingredientes = recipe.ingredients;
        } else if (typeof recipe.ingredients === 'string' && recipe.ingredients.trim()) {
          try {
            const parsed = JSON.parse(recipe.ingredients);
            ingredientes = Array.isArray(parsed) ? parsed : [recipe.ingredients];
          } catch (e) {
            ingredientes = [recipe.ingredients];
          }
        }

        // ------- NORMALIZA PASSOS -------
        let passos = [];
        if (Array.isArray(recipe.steps)) {
          passos = recipe.steps;
        } else if (typeof recipe.steps === 'string' && recipe.steps.trim()) {
          try {
            const parsedSteps = JSON.parse(recipe.steps);
            passos = Array.isArray(parsedSteps) ? parsedSteps : [recipe.steps];
          } catch (e) {
            passos = [recipe.steps];
          }
        }
      %>

      <h1 id="nome-receita"><%= recipe.title %></h1>

      <!-- BLOCO DE AÇÕES DA RECEITA (controlado via JS pelo autor) -->
      <div
        class="receita-acoes"
        data-author-id="<%= recipe.user_id %>"
        style="display:none;"
      >
        <button
          type="button"
          class="btn-acao-receita btn-editar-receita"
          title="Editar receita"
        >
          <img src="/assets/icon-editar.png" alt="Editar">
        </button>

        <button
          type="button"
          class="btn-acao-receita btn-excluir-receita"
          title="Excluir receita"
        >
          <img src="/assets/icon-excluir.png" alt="Excluir">
        </button>
      </div>

      <!-- IMAGEM CENTRAL -->
      <div class="imagem-central">
        <img
          id="imagem-receita"
          src="<%= recipe.cover_image %>"
          alt="<%= recipe.title %>"
        >
      </div>

      <!-- DETALHES DO AUTOR / META -->
      <div class="detalhes-receita">
        <a
          href="#"
          class="link-perfil-autor"
          data-author-id="<%= recipe.user_id %>"
          aria-label="Perfil do autor"
        >
          <img
            id="avatar-autor"
            src="<%= avatarUrl %>"
            alt="<%= recipe.author_name || 'Usuário' %>"
          >
        </a>

        <div class="texto-detalhes">
          <span class="nome-autor">
            <%= recipe.author_name || recipe.author_email || 'Autor' %>
          </span>
          <span id="tempo-preparo" class="tempo-preparo">
            <img src="/assets/icon-tempo.svg" alt="Tempo">
            <%= tempoFormatado %>
          </span>
        </div>
      </div>

      <!-- SOBRE -->
      <section class="sobre">
        <h2>Sobre a Receita</h2>
        <p id="sobre-receita"><%= recipe.description || '' %></p>
      </section>

      <!-- INGREDIENTES -->
      <section class="ingredientes">
        <h2>Ingredientes</h2>
        <ul id="ingredientes">
          <% if (ingredientes.length) { %>
            <% ingredientes.forEach(function(ing) { %>
              <li><%= ing %></li>
            <% }) %>
          <% } else { %>
            <li>Nenhum ingrediente cadastrado.</li>
          <% } %>
        </ul>
      </section>

      <!-- MODO DE PREPARO -->
      <section class="preparo">
        <h2>Modo de Preparo</h2>
        <ol id="modo-preparo">
          <% if (passos.length) { %>
            <% passos.forEach(function(step) { %>
              <li><%= step %></li>
            <% }) %>
          <% } else { %>
            <li>Nenhum passo cadastrado.</li>
          <% } %>
        </ol>
      </section>

      <!-- DICA DO CHEF -->
      <section class="dica-chef">
        <h2>Dica do Chef</h2>
        <p id="dica-chef"><%= recipe.tip || '' %></p>
      </section>

      <!-- COMENTÁRIOS -->
      <section class="comentarios">
        <h2>Comentários</h2>

        <!-- FORMULÁRIO DE NOVO COMENTÁRIO -->
        <form id="form-comentario" class="form-comentario">
          <textarea
            id="comentario-texto"
            rows="3"
            placeholder="Escreva um comentário..."
          ></textarea>
          <button type="submit" class="btn-enviar-comentario">Comentar</button>
        </form>

        <!-- LISTA DE COMENTÁRIOS -->
        <ul id="lista-comentarios" class="lista-comentarios">
          <% (comments || []).forEach(function(c){ %>
            <li
              class="comentario-item"
              data-comment-id="<%= c.id %>"
              data-comment-user-id="<%= c.user_id %>"
            >
              <div class="comentario-conteudo">
                <div class="comentario-topo">
                  <strong><%= c.author_name %></strong>
                  <span class="comentario-data">
                    <% if (c.created_at) { %>
                      <%= new Date(c.created_at).toLocaleDateString('pt-BR') %>
                    <% } %>
                  </span>
                </div>
                <p class="comentario-texto"><%= c.content %></p>
              </div>

              <div class="comentario-acoes">
                <button type="button" class="btn-editar-comentario">Editar</button>
                <button type="button" class="btn-excluir-comentario">Excluir</button>
              </div>
            </li>
          <% }) %>
        </ul>
      </section>
    </main>

    <%- include('partials/_footer') %>

    <script src="/js/categorias.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/receita.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
